
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Rogers Testsite</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="mqttws31.js" type="text/javascript"></script>
    <script src="smoothie.js" type="text/javascript"></script>
    <script src="https://cdn.rawgit.com/jprichardson/string.js/master/lib/string.min.js"></script>
    <script src="https://code.jquery.com/jquery-2.1.3.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.min.js"></script>

    <script type="text/javascript">
        var mqtt;
        var reconnectTimeout = 2000;
        var host = "formula.xrj.ch";
        var port = 9001;
        var username = "web";
        var password = "1234";
        var topic = "/can/#";
        var myLineChart;
        var chartdata;

        function MQTTconnect() {
            mqtt = new Paho.MQTT.Client(
                    host,
                    port,
                            "web_" + parseInt(Math.random() * 100,
                            10));
            var options = {
                timeout: 10,
                useSSL: false,
                cleanSession: true,
                onSuccess: onConnect,
                onFailure: function (message) {
                    $('#status').val("Connection failed: " + message.errorMessage + "Retrying");
                    setTimeout(MQTTconnect, reconnectTimeout);
                }
            };

            mqtt.onConnectionLost = onConnectionLost;
            mqtt.onMessageArrived = onMessageArrived;

            if (username != null) {
                options.userName = username;
                options.password = password;
            }
//        console.log("Host="+ host + ", port=" + port + " TLS = " + useTLS + " username=" + username + " password=" + password);
            mqtt.connect(options);
        }

        var smoothie = new SmoothieChart({millisPerPixel:7,grid:{fillStyle:'transparent'},maxValue:32200,minValue:-32200});
        // Data
        var lineX = new TimeSeries();
        var lineY = new TimeSeries();
        var lineZ = new TimeSeries();


        function initChart() {
            // Get context with jQuery - using jQuery's .get() method.

            smoothie.streamTo(document.getElementById("mycanvas"));

            // Add to SmoothieChart
            smoothie.addTimeSeries(lineX, { strokeStyle:'rgb(0, 255, 0)', lineWidth:1 });
            smoothie.addTimeSeries(lineY, { strokeStyle:'rgb(255, 0, 0)', lineWidth:1 });
            smoothie.addTimeSeries(lineZ, { strokeStyle:'rgb(0, 0, 255)', lineWidth:1 });

        }

        function onConnect() {
            $('#status').val('Connected to ' + host + ':' + port);
            // Connection succeeded; subscribe to our topic
            mqtt.subscribe(topic, {qos: 0});
            $('#topic').val(topic);
        }

        function onConnectionLost(response) {
            setTimeout(MQTTconnect, reconnectTimeout);
            $('#status').val("connection lost: " + response.errorMessage + ". Reconnecting");

        }

        function onMessageArrived(message) {

            var topic = message.destinationName;
            var payload = message.payloadString;

            var elements = topic.split('/');
            var i;

            if(elements[1] == 'sming') {

                if(elements[2] == 'measurement') {

                    var payloadObj = JSON.parse(payload);

                    var timestamp = new Date().getTime();
                    lineX.append(timestamp, payloadObj.point[0]);
                    lineY.append(timestamp, payloadObj.point[1]);
                    lineZ.append(timestamp, payloadObj.point[2]);

                    return;
                }
            }

            $('#ws').prepend('<li>' + moment().format() + ' - ' + topic + ' = ' + payload + '</li>');
        };


        $(document).ready(function() {
            initChart();
            MQTTconnect();
        });

    </script>
</head>
<body>
<h1>Rogers MQTT Demo</h1>
<div>
    <div>Subscribed to <input type='text' id='topic' disabled />
        Status: <input type='text' id='status' size="80" disabled /></div>


    <canvas style="margin: 20px" id="mycanvas" width="1000" height="400"></canvas>

    <p>Ache X: Gruen, Y: Rot, Z: Blau</p>
    <ul id='ws' style="font-family: 'Courier New', Courier, monospace;"></ul>

    <p>CAN0</p>

    <ul id='can' style="font-family: 'Courier New', Courier, monospace;"></ul>

</div>
</body>
</html>
