
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="Project 2 Demo">
    <meta name="author" content="Roger Jaggi">
    <!-- <link rel="icon" href="../../favicon.ico"> -->

    <title>Demo Project 2</title>

    <!-- Bootstrap core CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="main.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body>

<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Demo Project 2</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <!-- <ul class="nav navbar-nav navbar-right">
                <li><a href="#">Dashboard</a></li>
                <li><a href="#">Settings</a></li>
                <li><a href="#">Profile</a></li>
                <li><a href="#">Help</a></li>
            </ul>
            <form class="navbar-form navbar-right">
                <input type="text" class="form-control" placeholder="Search...">
            </form> -->
        </div>
    </div>
</nav>

<div class="container-fluid">
    <div class="row">
        <div class="col-sm-3 col-md-2 sidebar">
            <ul class="nav nav-sidebar">
                <li><a href="index.html">MQTT</a></li>
                <li class="active"><a href="sming.html">SMING <span class="sr-only">(current)</span></a></li>
                <li><a href="can.html">CAN-Bus</a></li>
                <li><a href="/nodered">NodeRed</a></li>
            </ul>
        </div>
        <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
            <h1 class="page-header">SMING</h1>

            <div>Subscribed to <input type='text' id='topic' disabled /> Status: <input type='text' id='status' size="80" disabled /></div>

            <h2 class="sub-header">Accelometer</h2>
            <canvas style="margin: 20px" id="mycanvas" width="1000" height="400"></canvas>

            <p><b>Achsenzuordnung:</b> X = Gr√ºn, Y = Rot, Z = Blau</p>


            <h2 class="sub-header">MQTT Log</h2>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                    <tr>
                        <th>#</th>
                        <th>Time</th>
                        <th>Topic</th>
                        <th>Payload</th>
                    </tr>
                    </thead>
                    <tbody id="outputlog">

                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap core JavaScript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script> -->
<script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>

<script src="mqttws31.js" type="text/javascript"></script>
<script src="smoothie.js" type="text/javascript"></script>
<script src="https://cdn.rawgit.com/jprichardson/string.js/master/lib/string.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.min.js"></script>

<script type="text/javascript">
    var mqtt;
    var reconnectTimeout = 2000;
    var host = "formula.xrj.ch";
    var port = 9001;
    var username = "web";
    var password = "1234";
    var topic = "/sming/+";
    var myLineChart;
    var chartdata;
    var count = 0;

    function MQTTconnect() {
        mqtt = new Paho.MQTT.Client(
                host,
                port,
                        "web_" + parseInt(Math.random() * 100,
                        10));
        var options = {
            timeout: 10,
            useSSL: false,
            cleanSession: true,
            onSuccess: onConnect,
            onFailure: function (message) {
                $('#status').val("Connection failed: " + message.errorMessage + "Retrying");
                setTimeout(MQTTconnect, reconnectTimeout);
            }
        };

        mqtt.onConnectionLost = onConnectionLost;
        mqtt.onMessageArrived = onMessageArrived;

        if (username != null) {
            options.userName = username;
            options.password = password;
        }
//        console.log("Host="+ host + ", port=" + port + " TLS = " + useTLS + " username=" + username + " password=" + password);
        mqtt.connect(options);
    }

    var smoothie = new SmoothieChart({millisPerPixel:7,grid:{fillStyle:'transparent'},maxValue:32200,minValue:-32200});
    // Data
    var lineX = new TimeSeries();
    var lineY = new TimeSeries();
    var lineZ = new TimeSeries();


    function initChart() {
        // Get context with jQuery - using jQuery's .get() method.

        smoothie.streamTo(document.getElementById("mycanvas"));

        // Add to SmoothieChart
        smoothie.addTimeSeries(lineX, { strokeStyle:'rgb(0, 255, 0)', lineWidth:1 });
        smoothie.addTimeSeries(lineY, { strokeStyle:'rgb(255, 0, 0)', lineWidth:1 });
        smoothie.addTimeSeries(lineZ, { strokeStyle:'rgb(0, 0, 255)', lineWidth:1 });

    }

    function onConnect() {
        $('#status').val('Connected to ' + host + ':' + port);
        // Connection succeeded; subscribe to our topic
        mqtt.subscribe(topic, {qos: 0});
        $('#topic').val(topic);
    }

    function onConnectionLost(response) {
        setTimeout(MQTTconnect, reconnectTimeout);
        $('#status').val("connection lost: " + response.errorMessage + ". Reconnecting");

    }

    function onMessageArrived(message) {

        var topic = message.destinationName;
        var payload = message.payloadString;

        var elements = topic.split('/');
        var i;

        if(elements[1] == 'sming') {

            if(elements[2] == 'measurement') {

                var payloadObj = JSON.parse(payload);

                var timestamp = new Date().getTime();
                lineX.append(timestamp, payloadObj.point[0]);
                lineY.append(timestamp, payloadObj.point[1]);
                lineZ.append(timestamp, payloadObj.point[2]);

                return;
            }
        }

        count += 1;
        $('#outputlog').prepend('<tr><td>' + count + '</td><td>' + moment().format() + '</td><td>' + topic + '</td><td>' + payload + '</td></tr>');
    };


    $(document).ready(function() {
        initChart();
        MQTTconnect();
    });

</script>
</body>
</html>
