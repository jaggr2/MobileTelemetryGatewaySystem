
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Rogers Testsite</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="mqttws31.js" type="text/javascript"></script>
    <script src="Chart.min.js" type="text/javascript"></script>
    <script src="https://cdn.rawgit.com/jprichardson/string.js/master/lib/string.min.js"></script>
    <script src="https://code.jquery.com/jquery-2.1.3.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.min.js"></script>

    <script type="text/javascript">
        var mqtt;
        var reconnectTimeout = 2000;
        var host = "formula.xrj.ch";
        var port = 9001;
        var username = "web";
        var password = "1234";
        var topic = "/computer/+/cpu";
        var myLineChart;
        var chartdata;

        function MQTTconnect() {
            mqtt = new Paho.MQTT.Client(
                    host,
                    port,
                            "web_" + parseInt(Math.random() * 100,
                            10));
            var options = {
                timeout: 10,
                useSSL: false,
                cleanSession: true,
                onSuccess: onConnect,
                onFailure: function (message) {
                    $('#status').val("Connection failed: " + message.errorMessage + "Retrying");
                    setTimeout(MQTTconnect, reconnectTimeout);
                }
            };

            mqtt.onConnectionLost = onConnectionLost;
            mqtt.onMessageArrived = onMessageArrived;

            if (username != null) {
                options.userName = username;
                options.password = password;
            }
//        console.log("Host="+ host + ", port=" + port + " TLS = " + useTLS + " username=" + username + " password=" + password);
            mqtt.connect(options);
        }

        function initChart() {
            // Get context with jQuery - using jQuery's .get() method.
            var ctx = $("#myChart").get(0).getContext("2d");

            var options = {};

            chartdata = {
                labels: ['','','','','','','','','','',''],
                datasets:
                        [
                            {
                                label: "CPU Usage %",
                                fillColor: "rgba(220,220,220,0.2)",
                                strokeColor: "rgba(220,220,220,1)",
                                pointColor: "rgba(220,220,220,1)",
                                pointStrokeColor: "#fff",
                                pointHighlightFill: "#fff",
                                pointHighlightStroke: "rgba(220,220,220,1)",
                                data: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
                            },
                            {
                                label: "Memory Usage %",
                                fillColor: "rgba(151,187,205,0.2)",
                                strokeColor: "rgba(151,187,205,1)",
                                pointColor: "rgba(151,187,205,1)",
                                pointStrokeColor: "#fff",
                                pointHighlightFill: "#fff",
                                pointHighlightStroke: "rgba(151,187,205,1)",
                                data: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
                            }
                        ]
            };

            // This will get the first returned node in the jQuery collection.
            myLineChart = new Chart(ctx).Line(chartdata, options);

        }

        function onConnect() {
            $('#status').val('Connected to ' + host + ':' + port);
            // Connection succeeded; subscribe to our topic
            mqtt.subscribe(topic, {qos: 0});
            $('#topic').val(topic);
        }

        function onConnectionLost(response) {
            setTimeout(MQTTconnect, reconnectTimeout);
            $('#status').val("connection lost: " + response.errorMessage + ". Reconnecting");

        };

        function onMessageArrived(message) {

            var topic = message.destinationName;
            var payload = message.payloadString;

            var elements = topic.split('/');
            var i;

            var compi = elements[2].toString();

            if(elements[1] == 'computer') {

                payloadObj = JSON.parse(payload);

                var percentCPU = S( parseFloat(payloadObj.cpu) * 100 ).toInteger();
                var percentMEM = S( parseFloat(payloadObj.mem_free) * 100 ).toInteger();

                console.log(payloadObj, percentCPU, percentMEM);

                myLineChart.removeData()
                myLineChart.addData([percentCPU, percentMEM], moment().format('HH:mm:ss'))
                myLineChart.update();
                return;
            }

            $('#ws').prepend('<li>' + moment().format() + ' - ' + topic + ' = ' + payload + '</li>');
        };


        $(document).ready(function() {
            initChart();
            MQTTconnect();
        });

    </script>
</head>
<body>
<h1>Rogers MQTT Demo</h1>
<div>
    <div>Subscribed to <input type='text' id='topic' disabled />
        Status: <input type='text' id='status' size="80" disabled /></div>


    <canvas id="myChart" width="800" height="400"></canvas>
    <ul id='ws' style="font-family: 'Courier New', Courier, monospace;"></ul>
</div>
</body>
</html>
